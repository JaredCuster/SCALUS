#!/usr/bin/perl

#This example perl script is used to customise an rdp file generated by scalus before presenting it to Microsoft Remote Desktop
#
# - CUSTOM SETTINGS
#   Add any settings that you wish to customize to this table

my %settings = qw{
    desktopwidth   i:1024 
    desktopheight  i:1024
};

# - CONFIGURE THE PASSWORD 
#   If you wish to set the password in the rdp file to avoid being prompted
#   when RDP starts up, provide an encrypted password here.
#   for example, run the command:
#   ("mypassword" | ConvertTo-SecureString -AsPlainText -Force) | ConvertFrom-SecureString; 
my $spass="encryptedpasswordvalue";

if ((not defined $filename) or 
	(not (-e $filename)) or
	(not (-r $filename)) or
	(not (-w $filename)))
{
    print "ERROR:invalid file: ${filename}\n";
    exit;
}

my $spassvalue="password 51:b:${spass}";
my $filename=$ARGV[0];
my $tmpfile = "${filename}.tmp";

open(DATA, "<${filename}") or die "ERROR:Couldnt open file ${filename}, $!";
open(TOFILE, ">${tmpfile}") or die "ERROR:Couldnt open file ${tmpfile}, $!";
while (<DATA>){
	chomp;
	my ($key, $valtype, $val) = split /:/, $_;
	if (not (exists $settings{$key})) {
		if ($key ne "password 51")
		{
			$settings{$key} = "${valtype}:${val}";
		}
	}

}
close (DATA);

for (keys %settings)  {
	print TOFILE "$_:$settings{$_}\n";
}
print TOFILE "${spassvalue}\n";
close (TOFILE);

unlink(${filename});
rename(${tmpfile}, ${filename});
